#### 一、基础
1、 协议栈（在操作系统内部，又叫网络控制软件，我们表面上看不见它工作），发出委托 --- 到web服务器

2、 Socket库（内有程序组件）

- 协议栈执行均调用socket中的组件完成
- 一般来说是：应用程序（如浏）委托协议栈收发数据
- 访问DNS服务器的时候，也是委托协议栈调用Socket库中的解析器程序组件

3、 信息传递需要管道，两边出口叫“套接字”

4、TCP/IP连接四步

- 服务器先创套接字并等待（创）
- 客户端也创套接字并连上服的套接字（连接）
- 通信：收发数据（通信）
- 断开管道并删了套接字（断）





#### 二、创、连接、通信、断
1、 客户端只是调用Socket中的组件，在内部完成创建套接字的操作。创建之后，会返回一个【描述符】（识别某个套接字），应用程序将它存于内存

2、连接上管道，也是通过Socket库中的组件，需要【描述符】【IP（分配给网络硬件的）】、【端口】。
服务器上的端口根据应用种类事先定好：如80端口是web/25端口是邮件

3、通信，通过用Socket库中的组件，服务器返回的消息会被Socket库放在应用程序内部的内存空间

4、断开。谁先断开都行

HTTP协议每获取一次数据就连接一次、然后断开，效率低，HTTP1.1, keep-alive

收发消息其实是三者结合完成的：【协议栈】、【网卡驱动】、【网卡】





#### 三、协议栈和网卡（用电信号传递TCP/IP数据）

下面将详细介绍 【TCP/IP协议收发数据的4个阶段】

1、TCP/IP采用分层结构：上面的能向下面的派发任务

- 最上层：应用软件（浏览器、服务器、客户端）
- 中间层：操作系统（协议栈 TCP UDP IP）
- 中间层：驱动程序（网卡驱动等）
- 最下层：硬件（网卡：收发网线中的信号）


2、套接字：只是概念，非实体。它记录了【用于控制通信操作的控制信息】，如【IP 端口 状态等】，协议栈可通过它做下一步行动


控制信息又分为2类：
- 类1：应用程序和服之间联络时交换的控制信息。TCP协议的规格中对这种信息的格式进行了定义，字段固定，每次交互时都要：【发送方/收方端口】【序号】【ACK】，它被放在传递的网络包的开头，被称为‘头部’
- 保存在套接字中，为控制协议栈的操作，如，状态信息、传递的信息

连接的过程中，还有ACK SYN等会改变值

3、收发数据
应用程 ---> 调用write，把数据交给协议栈（它只认识二进制字节的序列），会攒够一定数据才会发送

一个网络包的最大长度叫MTU，在以太网中一般是1500字节

包发送有2种模式：1、包装满再发（可能导致延时）、2、固定时间发一次（可能包没满），用哪种模式，由协议栈的开发者控制

会对较大的数据进行拆分

ACK号：用来确认网络包已到到
- 发送方：序号（随机的，以防被攻击）+ 字节数1460字节
- 收方：ACK号1461

发方、收方，一来一回一ACK，效率不高

更高的方法：接收方告诉发送方自己缓冲区的最大容量（‘窗口大小’）, 发方可一次性发多个包，接收方处理完之后再发ACK号

TCP整体流程：如图‘留存图-图1’

![image-20190920230018123](/Users/liuyue/Library/Application Support/typora-user-images/image-20190920230018123.png)

TCP会将请求消息切成小块，每块前加上TDP头部（TCP头部包含序号，发的是第几个字节的数据），然后发给服





#### 四、IP与以太网的包收发操作

1、以太网中TCP/IP的思路行不通，所以只有IP头的话，不行。出现了MAC头。

查路由表（Gatewag）的IP，但此时还是不知下一个路由的Mac地址，收发包时必须知道对方的MAC

IP ----> MAC 通过ARP实现

2、ARP
地址解析协议

1、以太网中，‘广播’，可以把包发给连接在同一以太网中的所有设备，ARP利用这一特性访问所有设备，快把你的MAC告诉我，不是这个IP的设备会忽略广播。若每次都发送ARP包，太浪费，把查到的放ARP缓存里。只有在局域网里，才会作出ARP响应，ARP缓存一般几分钟删一次，免得IP变动，MAC对不上

MAC：Media Access Control

2、通过网卡，通过网线，将IP包数字信号 ---->  转成电/光信号发送出去

需要让0 ， 1对应不同的电流、电压

