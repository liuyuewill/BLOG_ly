<!doctype html>
<head>
  <title>test</title>
</head>
<body>
  <div id="loginBtn">click</div>
  <div id="backAction">backAction</div>
  <script>
    // 练习状态模式start
    function Light(){
        this.status = 'off'
    }

    Light.prototype.enter = function (){
        if (this.status === 'on') {
            this.status = 'off'
            console.log('off')
        } else if (this.status === 'off') {
            this.status = 'on'
            console.log('on')
        }
    }

    Light.prototype.init = function () {
        let self = this
        let btn = document.createElement('button')
        btn.innerHTML = '开关'
        document.body.appendChild(btn)

        btn.onclick = function(){
            self.enter()
        }

    }
    let lig = new Light()
    lig.init()
    // 练习状态模式end



    const createLoginLayer = function () {
      const div = document.createElement('div')
      div.innerHTML = 'HELLO WORLD'
      div.style.display = 'none'
      document.body.appendChild(div)
      return div
    }
    function getSingle(fn) {
        let res = null  // 重点部分，是个闭包
        return function () {
          if (!res){
            res = fn.apply(this, arguments)
          }
          return res
        }
      }

    const createSingleLoginLayer = getSingle(createLoginLayer)
    document.getElementById('loginBtn').onclick = function () {
      let loginLayer = createSingleLoginLayer()
      loginLayer.style.display = 'block'
    }


    // 练习命令模式 start
    let actionType = {
      openDoor(){
          console.log('openDoor')
      },
      washHands(){
          console.log('washHands')
      },
      playCats(){
          console.log('playCats')
      },
      openComputer(){
          console.log('openComputer')
      }
    }

    function actionCommand(receiver, state){
        return function () {
          receiver[state]()
        }
    }

    let press = {
        '113': 'openDoor',
        '119': 'washHands',
        '101': 'playCats',
        '114': 'openComputer'
    }

    let commandTask = []
    document.onkeypress = function(e){
        let keyCode = e.keyCode
        let command = actionCommand(actionType, press[keyCode])
        commandTask.push(command)
        command()
    }
    document.getElementById('backAction').onclick = function(){
      while (commandTask.length){
        let command = commandTask.shift()
        command()
      }
    }
    // 练习命令模式 end



    // 业务代码
    const order500 = function(orderType, pay, stock) {
      if ( orderType === 1 && pay === true ) {
        console.log('500 元定金预购, 得到 100 元优惠券')
      } else {
        return 'nextSuccess'
      }
    }

    const order200 = function(orderType, pay, stock) {
      if ( orderType === 2 && pay === true ) {
        console.log('200 元定金预购, 得到 50 元优惠券')
      } else {
        return 'nextSuccess'
      }
    }

    const orderCommon = function(orderType, pay, stock) {
      if (orderType === 3 && stock > 0) {
        console.log('普通购买, 无优惠券')
      } else {
        console.log('库存不够, 无法购买')
      }
    }

    // 链路代码
    Function.prototype.after = function(fn) {
      const self = this
      return function() {
        const result = self.apply(self, arguments)
        if (result === 'nextSuccess') {
          return fn.apply(self, arguments) // 这里 return 别忘记了~
        }
      }
    }

    // const order = order500.after(order200).after(orderCommon)
    // order( 3, true, 500 )
    // console.log('order', order);
    console.log('order', order500.after(order200));

    function Animal (type, sound) {
      this.sound = sound
      this.type = type
    }
    Animal.prototype.makeSound = function () {
      console.log(this.sound);
    }

  </script>
</body>
</html>